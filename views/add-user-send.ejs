<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css">
  <link href="https://fonts.googleapis.com/css?family=Niramit" rel="stylesheet">
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous"> -->
  <style>
    body {
      font-family: 'Niramit', sans-serif;
    }
  </style>

  <title>User Add</title>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h2>รายชื่อลูกค้าทั้งหมด</h2>
        <table data-toggle="table" data-search="true" data-show-columns="true" data-show-refresh="true"
          data-page-list="[10, 25, 50, 100, ALL]" data-show-pagination-switch="true" data-pagination="true">
          <thead>
            <tr>
              <th><input type="checkbox" id="source-user" onclick="toggleAddUserAll()" /></th>
              <th data-field="number">ลำดับ</th>
              <th data-field="id">ไอดี</th>
              <th data-field="name">ชื่อ</th>
              <th data-field="email">อีเมล</th>
              <th data-field="type">ประเภท</th>
              <th data-field="phone">เบอร์โทร</th>
              <th data-field="age">อายุ</th>
              <th data-field="date">เวลา</th>
            </tr>
          </thead>
          <tbody>
            <% data.map((order,key)=>{ %>
              <tr data-index="<%= key %>">
                <td><input type="checkbox" name="selection-user" /></td>
                <td>
                  <%= key+1 %>
                </td>
                <td>
                  <%= order.id %>
                </td>
                <td>
                  <%= order.name %>
                </td>
                <td>
                  <%= order.email %>
                </td>
                <td>
                  <%= order.type %>
                </td>
                <td>
                  <%= order.phone %>
                </td>
                <td>
                  <%= order.age %>
                </td>
                <td>
                  <%= new Date(order.date * 1000) %>
                </td>
              </tr>

              <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div style="    display: flex;
  justify-content: center;">
    <button onclick="updateUserTotal()" class="btn btn-warning">เพิ่มอีเมลที่จะทำการส่ง</button>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h2>รายชื่อลูกค้าที่จัดเตรียมจะส่ง</h2>
        <table data-toggle="table" data-search="true" data-show-columns="true" data-show-refresh="true"
          data-page-list="[10, 25, 50, 100, ALL]" data-show-pagination-switch="true" data-pagination="true">
          <thead>
            <tr>
              <th><input type="checkbox" id="source-send-mail" onclick="toggleSendUserAll()" /></th>
              <th data-field="number">ลำดับ</th>
              <th data-field="id">ไอดี</th>
              <th data-field="uid">ไอดีลูกค้า</th>
              <th data-field="name">ชื่อ</th>
              <th data-field="email">อีเมล</th>
              <th data-field="type">ประเภท</th>
              <th data-field="phone">เบอร์โทร</th>
              <th data-field="age">อายุ</th>
              <th data-field="date">เวลา</th>
            </tr>
          </thead>
          <tbody>
            <% addData.map((order,key)=>{ %>
              <tr data-index="<%= key %>">
                <td><input type="checkbox" name="selection-send-mail" /></td>
                <td>
                  <%= key+1 %>
                </td>
                <td>
                  <%= order.id %>
                </td>
                <td>
                  <%= order.uid %>
                </td>
                <td>
                  <%= order.name %>
                </td>
                <td>
                  <%= order.email %>
                </td>
                <td>
                  <%= order.type %>
                </td>
                <td>
                  <%= order.phone %>
                </td>
                <td>
                  <%= order.age %>
                </td>
                <td>
                  <%= new Date(order.date * 1000) %>
                </td>
              </tr>

              <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div style="    display: flex;
  justify-content: center;">
    <button onclick="updateSendEmail()" class="btn btn-success">ส่งอีเมล</button>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h2>ประวัติการส่ง</h2>
        <table data-toggle="table" data-search="true" data-show-columns="true" data-show-refresh="true"
          data-page-list="[10, 25, 50, 100, ALL]" data-show-pagination-switch="true" data-pagination="true">
          <thead>
            <tr>
              <!-- <th><input type="checkbox" id="source-send-mail" onclick="toggleSendUserAll()" /></th> -->
              <th data-field="number">ลำดับ</th>
              <th data-field="id">ไอดี</th>
              <th data-field="uid">ไอดีลูกค้า</th>
              <th data-field="name">ชื่อ</th>
              <th data-field="email">อีเมล</th>
              <th data-field="type">ประเภท</th>
              <th data-field="phone">เบอร์โทร</th>
              <th data-field="age">อายุ</th>
              <th data-field="date">เวลา</th>
            </tr>
          </thead>
          <tbody>
            <% historyData.map((order,key)=>{ %>
              <tr data-index="<%= key %>">
                <!-- <td><input type="checkbox" name="selection-send-mail" /></td> -->
                <td>
                  <%= key+1 %>
                </td>
                <td>
                  <%= order.id %>
                </td>
                <td>
                  <%= order.uid %>
                </td>
                <td>
                  <%= order.name %>
                </td>
                <td>
                  <%= order.email %>
                </td>
                <td>
                  <%= order.type %>
                </td>
                <td>
                  <%= order.phone %>
                </td>
                <td>
                  <%= order.age %>
                </td>
                <td>
                  <%= new Date(order.date * 1000) %>
                </td>
              </tr>

              <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    // Globals
    const sourceUser = document.getElementById("source-user")
    const sourceSendMail = document.getElementById("source-send-mail")
    const checkboxesUser = document.getElementsByName("selection-user")
    const checkboxesSendMail = document.getElementsByName("selection-send-mail")

    // // Listeners
    // source.addEventListener("change", toggleAll())
    // for (let box of checkboxes){
    //   box.addEventListener("change", updateTotal());
    // }

    // Functions
    function toggleAddUserAll() {
      sourceUser.checked = !sourceUser.checked
      console.log(sourceUser.checked);
      for (let box of checkboxesUser) {

        box.checked = sourceUser.checked;
      }
      // updateTotal();
    }

    function toggleSendUserAll() {
      sourceSendMail.checked = !sourceSendMail.checked
      console.log(sourceSendMail.checked);
      for (let box of checkboxesSendMail) {

        box.checked = sourceSendMail.checked;
      }
      // updateTotal();
    }

    function updateUserTotal() {
      let currentTotal = 0;
      const _arr = []
      for (let box of checkboxesUser) {
        if (box.checked) {
          var row = box.closest("TR");
          let data = {
            "uid": row.children[2].innerText,
            "name": row.children[3].innerText,
            "email": row.children[4].innerText,
            "type": row.children[5].innerText,
            "phone": row.children[6].innerText,
            "age": row.children[7].innerText,
            "date": row.children[8].innerText
          };
          // console.log(data);
          _arr.push(data)

        }
      }

      var myHeaders = new Headers();
      myHeaders.append("Content-Type", "application/json");

      var raw = JSON.stringify({ "data": _arr });

      var requestOptions = {
        method: 'POST',
        headers: myHeaders,
        body: raw,
        redirect: 'follow'
      };

      fetch("/api/add-user-send", requestOptions)
        .then(response => response.text())
        .then(result => {
          window.location.reload();
          // console.log(result)
        }
        )
        .catch(error => console.log('error', error));

    }

    function updateSendEmail() {
      let currentTotal = 0;
      const _arr = []
      for (let box of checkboxesSendMail) {
        if (box.checked) {
          var row = box.closest("TR");
          let data = {
            "uid": row.children[3].innerText,
            "name": row.children[4].innerText,
            "email": row.children[5].innerText,
            "type": row.children[6].innerText,
            "phone": row.children[7].innerText,
            "age": row.children[8].innerText,
            "date": row.children[9].innerText
          };
          // console.log(data);
          _arr.push(data)

        }
      }

      var myHeaders = new Headers();
      myHeaders.append("Content-Type", "application/json");

      var raw = JSON.stringify({ "data": _arr });

      var requestOptions = {
        method: 'POST',
        headers: myHeaders,
        body: raw,
        redirect: 'follow'
      };

      fetch("/api/send-email", requestOptions)
        .then(response => response.text())
        .then(result => {
          window.location.reload();
          console.log(result)
        }
        )
        .catch(error => console.log('error', error));

    }

  </script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
  <script src="http://issues.wenzhixin.net.cn/bootstrap-table/assets/bootstrap/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-th-TH.min.js"></script>
</body>

</html>